<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¾…åŠäº‹é¡¹ - å‰åç«¯è¿é€šæ¼”ç¤º</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            padding: 30px;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
        }

        .header h1 {
            color: #333;
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .status {
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            font-weight: bold;
        }

        .status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .form-section {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 30px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #555;
        }

        .form-group input,
        .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e1e5f7;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s;
        }

        .form-group input:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 25px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s;
            margin-right: 10px;
            margin-bottom: 10px;
        }

        .btn:hover {
            transform: translateY(-2px);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .btn.danger {
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%);
        }

        .btn.success {
            background: linear-gradient(135deg, #00b894 0%, #00a085 100%);
        }

        .todo-list {
            margin-top: 30px;
        }

        .todo-item {
            background: white;
            border: 2px solid #e1e5f7;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 15px;
            transition: all 0.3s;
        }

        .todo-item:hover {
            border-color: #667eea;
            transform: translateY(-2px);
        }

        .todo-item.completed {
            opacity: 0.7;
            border-color: #00b894;
        }

        .todo-title {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 8px;
            color: #333;
        }

        .todo-title.completed {
            text-decoration: line-through;
            color: #666;
        }

        .todo-description {
            color: #666;
            margin-bottom: 15px;
            line-height: 1.5;
        }

        .todo-meta {
            font-size: 12px;
            color: #999;
            margin-bottom: 15px;
        }

        .todo-actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .api-info {
            background: #e8f4fd;
            border: 1px solid #bee5eb;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
            font-size: 14px;
            color: #0c5460;
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 15px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            border: 2px solid #e1e5f7;
        }

        .stat-number {
            font-size: 24px;
            font-weight: bold;
            color: #667eea;
        }

        .stat-label {
            font-size: 12px;
            color: #666;
            margin-top: 5px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸš€ å¾…åŠäº‹é¡¹åº”ç”¨</h1>
            <p>æ¼”ç¤ºå‰åç«¯å¦‚ä½•è¿é€š</p>
        </div>

        <!-- API è¿æ¥çŠ¶æ€ -->
        <div id="connectionStatus" class="status">
            <div class="spinner"></div>
            æ­£åœ¨è¿æ¥åç«¯æœåŠ¡å™¨...
        </div>

        <!-- API ä¿¡æ¯è¯´æ˜ -->
        <div class="api-info">
            <strong>ğŸ”— å‰åç«¯è¿é€šåŸç†ï¼š</strong><br>
            1. å‰ç«¯é€šè¿‡ <code>fetch()</code> å‘é€ HTTP è¯·æ±‚åˆ°åç«¯ API<br>
            2. åç«¯ Flask æœåŠ¡å™¨å¤„ç†è¯·æ±‚ï¼Œæ“ä½œæ•°æ®åº“<br>
            3. åç«¯è¿”å› JSON æ•°æ®ç»™å‰ç«¯<br>
            4. å‰ç«¯æ¥æ”¶æ•°æ®å¹¶æ›´æ–°ç•Œé¢<br>
            <strong>åç«¯åœ°å€ï¼š</strong> <code id="apiUrl">http://127.0.0.1:5000/api</code>
        </div>

        <!-- ç»Ÿè®¡ä¿¡æ¯ -->
        <div class="stats">
            <div class="stat-card">
                <div class="stat-number" id="totalCount">0</div>
                <div class="stat-label">æ€»è®¡</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="completedCount">0</div>
                <div class="stat-label">å·²å®Œæˆ</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="pendingCount">0</div>
                <div class="stat-label">å¾…å®Œæˆ</div>
            </div>
        </div>

        <!-- æ·»åŠ å¾…åŠäº‹é¡¹è¡¨å• -->
        <div class="form-section">
            <h3>ğŸ“ æ·»åŠ æ–°å¾…åŠäº‹é¡¹</h3>
            <div class="form-group">
                <label for="todoTitle">æ ‡é¢˜</label>
                <input type="text" id="todoTitle" placeholder="è¾“å…¥å¾…åŠäº‹é¡¹æ ‡é¢˜..." maxlength="200">
            </div>
            <div class="form-group">
                <label for="todoDescription">æè¿°ï¼ˆå¯é€‰ï¼‰</label>
                <textarea id="todoDescription" rows="3" placeholder="è¯¦ç»†æè¿°..."></textarea>
            </div>
            <button class="btn" onclick="createTodo()">
                â• æ·»åŠ å¾…åŠäº‹é¡¹
            </button>
        </div>

        <!-- æ“ä½œæŒ‰é’® -->
        <div style="margin-bottom: 20px;">
            <button class="btn" onclick="fetchTodos()">ğŸ”„ åˆ·æ–°åˆ—è¡¨</button>
            <button class="btn success" onclick="testConnection()">ğŸ”§ æµ‹è¯•è¿æ¥</button>
            <button class="btn danger" onclick="clearAllCompleted()">ğŸ—‘ï¸ æ¸…é™¤å·²å®Œæˆ</button>
        </div>

        <!-- å¾…åŠäº‹é¡¹åˆ—è¡¨ -->
        <div class="todo-list">
            <h3>ğŸ“‹ å¾…åŠäº‹é¡¹åˆ—è¡¨</h3>
            <div id="todoContainer">
                <div class="loading">
                    <div class="spinner"></div>
                    åŠ è½½ä¸­...
                </div>
            </div>
        </div>
    </div>

    <script>
        // ğŸŒ API åŸºç¡€é…ç½®
        const API_BASE = 'http://127.0.0.1:5000/api';
        let todos = [];

        // ğŸš€ é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            console.log('ğŸŒŸ å‰ç«¯åº”ç”¨å¯åŠ¨');
            testConnection();
        });

        // ğŸ”§ æµ‹è¯•åç«¯è¿æ¥
        async function testConnection() {
            console.log('ğŸ” æµ‹è¯•åç«¯è¿æ¥...');
            updateStatus('æ­£åœ¨æµ‹è¯•è¿æ¥...', 'info');
            
            try {
                const response = await fetch(`${API_BASE}/todos`);
                console.log('ğŸ“¡ æ”¶åˆ°å“åº”:', response.status);
                
                if (response.ok) {
                    updateStatus('âœ… åç«¯è¿æ¥æˆåŠŸï¼', 'success');
                    fetchTodos();
                } else {
                    throw new Error(`HTTP ${response.status}`);
                }
            } catch (error) {
                console.error('âŒ è¿æ¥å¤±è´¥:', error);
                updateStatus(`âŒ åç«¯è¿æ¥å¤±è´¥: ${error.message}`, 'error');
            }
        }

        // ğŸ“Š æ›´æ–°è¿æ¥çŠ¶æ€æ˜¾ç¤º
        function updateStatus(message, type) {
            const statusEl = document.getElementById('connectionStatus');
            statusEl.innerHTML = message;
            statusEl.className = `status ${type}`;
        }

        // ğŸ“¥ è·å–æ‰€æœ‰å¾…åŠäº‹é¡¹
        async function fetchTodos() {
            console.log('ğŸ“¥ è·å–å¾…åŠäº‹é¡¹åˆ—è¡¨');
            
            try {
                const response = await fetch(`${API_BASE}/todos`);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                todos = await response.json();
                console.log('ğŸ“‹ è·å–åˆ°', todos.length, 'ä¸ªå¾…åŠäº‹é¡¹');
                
                renderTodos();
                updateStats();
                
            } catch (error) {
                console.error('âŒ è·å–å¾…åŠäº‹é¡¹å¤±è´¥:', error);
                document.getElementById('todoContainer').innerHTML = 
                    `<div class="status error">è·å–æ•°æ®å¤±è´¥: ${error.message}</div>`;
            }
        }

        // â• åˆ›å»ºæ–°å¾…åŠäº‹é¡¹
        async function createTodo() {
            const title = document.getElementById('todoTitle').value.trim();
            const description = document.getElementById('todoDescription').value.trim();
            
            if (!title) {
                alert('è¯·è¾“å…¥æ ‡é¢˜ï¼');
                return;
            }

            console.log('â• åˆ›å»ºå¾…åŠäº‹é¡¹:', title);
            
            try {
                const response = await fetch(`${API_BASE}/todos`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        title: title,
                        description: description
                    })
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const newTodo = await response.json();
                console.log('âœ… åˆ›å»ºæˆåŠŸ:', newTodo);
                
                // æ¸…ç©ºè¡¨å•
                document.getElementById('todoTitle').value = '';
                document.getElementById('todoDescription').value = '';
                
                // åˆ·æ–°åˆ—è¡¨
                fetchTodos();
                
            } catch (error) {
                console.error('âŒ åˆ›å»ºå¤±è´¥:', error);
                alert(`åˆ›å»ºå¤±è´¥: ${error.message}`);
            }
        }

        // ğŸ”„ åˆ‡æ¢å®ŒæˆçŠ¶æ€
        async function toggleTodo(id, completed) {
            console.log('ğŸ”„ åˆ‡æ¢å¾…åŠäº‹é¡¹çŠ¶æ€:', id, 'â†’', !completed);
            
            try {
                const response = await fetch(`${API_BASE}/todos/${id}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        completed: !completed
                    })
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                
                console.log('âœ… çŠ¶æ€æ›´æ–°æˆåŠŸ');
                fetchTodos();
                
            } catch (error) {
                console.error('âŒ æ›´æ–°å¤±è´¥:', error);
                alert(`æ›´æ–°å¤±è´¥: ${error.message}`);
            }
        }

        // ğŸ—‘ï¸ åˆ é™¤å¾…åŠäº‹é¡¹
        async function deleteTodo(id, title) {
            if (!confirm(`ç¡®å®šè¦åˆ é™¤ "${title}" å—ï¼Ÿ`)) {
                return;
            }

            console.log('ğŸ—‘ï¸ åˆ é™¤å¾…åŠäº‹é¡¹:', id);
            
            try {
                const response = await fetch(`${API_BASE}/todos/${id}`, {
                    method: 'DELETE'
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                
                console.log('âœ… åˆ é™¤æˆåŠŸ');
                fetchTodos();
                
            } catch (error) {
                console.error('âŒ åˆ é™¤å¤±è´¥:', error);
                alert(`åˆ é™¤å¤±è´¥: ${error.message}`);
            }
        }

        // ğŸ§¹ æ¸…é™¤æ‰€æœ‰å·²å®Œæˆçš„å¾…åŠäº‹é¡¹
        async function clearAllCompleted() {
            const completedTodos = todos.filter(todo => todo.completed);
            
            if (completedTodos.length === 0) {
                alert('æ²¡æœ‰å·²å®Œæˆçš„å¾…åŠäº‹é¡¹');
                return;
            }
            
            if (!confirm(`ç¡®å®šè¦åˆ é™¤ ${completedTodos.length} ä¸ªå·²å®Œæˆçš„å¾…åŠäº‹é¡¹å—ï¼Ÿ`)) {
                return;
            }
            
            console.log('ğŸ§¹ æ‰¹é‡åˆ é™¤å·²å®Œæˆçš„å¾…åŠäº‹é¡¹');
            
            for (const todo of completedTodos) {
                try {
                    await fetch(`${API_BASE}/todos/${todo.id}`, {
                        method: 'DELETE'
                    });
                } catch (error) {
                    console.error('åˆ é™¤å¤±è´¥:', todo.title, error);
                }
            }
            
            fetchTodos();
        }

        // ğŸ¨ æ¸²æŸ“å¾…åŠäº‹é¡¹åˆ—è¡¨
        function renderTodos() {
            const container = document.getElementById('todoContainer');
            
            if (todos.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #666;">
                        <h3>ğŸ“ è¿˜æ²¡æœ‰å¾…åŠäº‹é¡¹</h3>
                        <p>æ·»åŠ ä½ çš„ç¬¬ä¸€ä¸ªå¾…åŠäº‹é¡¹å§ï¼</p>
                    </div>
                `;
                return;
            }
            
            // æŒ‰åˆ›å»ºæ—¶é—´æ’åºï¼Œæœªå®Œæˆçš„åœ¨å‰
            const sortedTodos = [...todos].sort((a, b) => {
                if (a.completed !== b.completed) {
                    return a.completed ? 1 : -1;
                }
                return new Date(b.created_at) - new Date(a.created_at);
            });
            
            container.innerHTML = sortedTodos.map(todo => `
                <div class="todo-item ${todo.completed ? 'completed' : ''}">
                    <div class="todo-title ${todo.completed ? 'completed' : ''}">${todo.title}</div>
                    ${todo.description ? `<div class="todo-description">${todo.description}</div>` : ''}
                    <div class="todo-meta">
                        ğŸ“… åˆ›å»ºäº: ${new Date(todo.created_at).toLocaleString('zh-CN')} | 
                        ID: ${todo.id} | 
                        çŠ¶æ€: ${todo.completed ? 'âœ… å·²å®Œæˆ' : 'â³ å¾…å®Œæˆ'}
                    </div>
                    <div class="todo-actions">
                        <button class="btn ${todo.completed ? '' : 'success'}" 
                                onclick="toggleTodo(${todo.id}, ${todo.completed})">
                            ${todo.completed ? 'â†©ï¸ æ ‡è®°æœªå®Œæˆ' : 'âœ… æ ‡è®°å®Œæˆ'}
                        </button>
                        <button class="btn danger" onclick="deleteTodo(${todo.id}, '${todo.title}')">
                            ğŸ—‘ï¸ åˆ é™¤
                        </button>
                    </div>
                </div>
            `).join('');
        }

        // ğŸ“Š æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
        function updateStats() {
            const total = todos.length;
            const completed = todos.filter(todo => todo.completed).length;
            const pending = total - completed;
            
            document.getElementById('totalCount').textContent = total;
            document.getElementById('completedCount').textContent = completed;
            document.getElementById('pendingCount').textContent = pending;
        }

        // âŒ¨ï¸ å¿«æ·é”®æ”¯æŒ
        document.addEventListener('keydown', function(e) {
            if (e.ctrlKey && e.key === 'Enter') {
                createTodo();
            }
        });

        // ğŸ’¡ æ˜¾ç¤ºå¿«æ·é”®æç¤º
        document.getElementById('todoTitle').addEventListener('focus', function() {
            if (!this.getAttribute('data-tip-shown')) {
                alert('ğŸ’¡ å°è´´å£«ï¼šæŒ‰ Ctrl + Enter å¿«é€Ÿæ·»åŠ å¾…åŠäº‹é¡¹ï¼');
                this.setAttribute('data-tip-shown', 'true');
            }
        });
    </script>
</body>
</html>